name: A) Deployment Train

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      deploy_be:
        description: 'Deploy BE'
        required: false
        default: false
        type: boolean
      deploy_fe:
        description: 'Deploy FE'
        required: false
        default: false
        type: boolean
      deploy_maze:
        description: 'Deploy Maze'
        required: false
        default: false
        type: boolean
      target_env:
        description: 'Environment'
        required: true
        default: CANARY
        type: choice
        options:
          - PROD
          - CANARY
          - DEV

jobs:
  dispatch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Validate deploy source branch
        shell: bash
        run: |
          set -e

          REF="${GITHUB_REF#refs/heads/}"
          TARGET_ENV="${{ github.event.inputs.target_env }}"

          if [[ ("$TARGET_ENV" == "PROD" || "$TARGET_ENV" == "CANARY") && "$REF" != release/* ]]; then
            echo "âŒ $TARGET_ENV deployments must run from release/* branches"
            exit 1
          fi

      - name: Set deployment environment
        run: |
          echo "TARGET_BRANCH=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_ENV
          if [ "${GITHUB_EVENT_NAME}" = "push" ]; then
            echo "DEPLOY_ENV=DEV" >> $GITHUB_ENV
            echo "DEPLOY_BE=true" >> $GITHUB_ENV
            echo "DEPLOY_FE=true" >> $GITHUB_ENV
            echo "DEPLOY_MAZE=false" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=${{ github.event.inputs.target_env }}" >> $GITHUB_ENV
            echo "DEPLOY_BE=${{ github.event.inputs.deploy_be }}" >> $GITHUB_ENV
            echo "DEPLOY_FE=${{ github.event.inputs.deploy_fe }}" >> $GITHUB_ENV
            echo "DEPLOY_MAZE=${{ github.event.inputs.deploy_maze }}" >> $GITHUB_ENV
          fi

      - name: Dispatch Backend Deploy
        if: env.DEPLOY_BE == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: deploy_be
          client-payload: '{"env": "${{ env.DEPLOY_ENV }}", "target_branch": "${{ env.TARGET_BRANCH }}"}'

      - name: Dispatch Frontend Deploy
        if: env.DEPLOY_FE == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: deploy_fe
          client-payload: '{"env": "${{ env.DEPLOY_ENV }}", "target_branch": "${{ env.TARGET_BRANCH }}"}'

      - name: Dispatch MAZE Deploy
        if: env.DEPLOY_MAZE == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: deploy_maze
          client-payload: '{"env": "${{ env.DEPLOY_ENV }}", "target_branch": "${{ env.TARGET_BRANCH }}"}'
